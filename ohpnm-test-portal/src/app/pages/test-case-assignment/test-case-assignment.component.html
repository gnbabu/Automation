<div class="test-case-assignments-container">
  <div class="page-container">
    <!-- Header -->
    <div
      class="header-section d-flex justify-content-between align-items-start"
    >
      <div>
        <h1>Test Case Assignment</h1>
        <small
          ><i class="bi bi-person-gear me-1"></i> Administrative Task</small
        >
      </div>
    </div>

    <!-- Filter Section -->
    <div
      class="filter-card d-flex flex-wrap align-items-center justify-content-between"
    >
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div>
          <label for="librarySelect" class="form-label">Test Suite</label>
          <app-dropdown
            id="librarySelect"
            [options]="libraries"
            valueAccessor="libraryName"
            textAccessor="libraryName"
            placeholder="All Suites"
            [(selected)]="selectedLibrary"
            (selectionChange)="onLibraryChange($event)"
          >
          </app-dropdown>
        </div>
        <div>
          <label for="assignmentStatusSelect" class="form-label"
            >Assignment Status</label
          >
          <app-dropdown
            id="assignmentStatusSelect"
            [options]="assignmentStatuses"
            valueAccessor="assignmentStatus"
            textAccessor="assignmentStatus"
            placeholder="All Statuses"
            [(selected)]="selectedAssignmentStatus"
            (selectionChange)="onAssignmentStatusChange($event)"
          >
          </app-dropdown>
        </div>
      </div>
      <div class="d-flex gap-3">
        <div class="stats-box">
          <div class="stats-number">{{ totalCases }}</div>
          <div class="stats-label">Total Cases</div>
        </div>
        <div class="stats-box">
          <div class="stats-number text-primary">{{ unassignedCount }}</div>
          <div class="stats-label">Unassigned</div>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="table-card">
      <h5>Pending Test Case List</h5>
      <div class="table-responsive">
        <app-data-grid
          [columns]="columns"
          [pagingEnabled]="false"
          [data]="testCases"
          [selectionEnabled]="false"
        ></app-data-grid>
      </div>

      <div class="footer-note">
        … {{ unassignedCount }} more test cases pending assignment. Use the
        checkboxes and the floating bar for bulk actions.
      </div>
    </div>
  </div>
</div>

<!-- Priority Template -->
<ng-template #priorityTemplate let-row let-value="value">
  <span
    [ngClass]="{
      'priority-high': value === 'High',
      'priority-medium': value === 'Medium',
      'priority-low': value === 'Low'
    }"
  >
    {{ value }}
  </span>
</ng-template>

<!-- ✅ Current Status Template -->
<ng-template #assignedUsersTemplate let-row let-value="value">
  <div class="d-flex flex-wrap gap-1">
    <span *ngFor="let user of value ?? []" class="badge bg-primary">
      {{ user.userName }}
      <i
        class="bi bi-x-circle ms-1 text-light cursor-pointer"
        (click)="unassignUser(row, user)"
      ></i>
    </span>

    <span *ngIf="!(value?.length ?? 0)" class="status-pill status-unassigned">
      Unassigned
    </span>
  </div>
</ng-template>

<!-- ✅ Assign Tester Template -->
<ng-template #assignTesterTemplate let-row="$implicit">
  <app-multiselect-dropdown
    [options]="users"
    [(ngModel)]="row.assignedUsers"
    textAccessor="userName"
    valueAccessor="userId"
    placeholder="Select Tester"
    (selectionChange)="onUsersChange($event, row)"
    (selectAllClicked)="onSelectAll($event, row)"
    (clearAllClicked)="onClearAll(row)"
  ></app-multiselect-dropdown>
</ng-template>
